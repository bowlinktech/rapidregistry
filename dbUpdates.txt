/** grace 02.03.2015 03:08AM **/
ALTER TABLE `rapidregistry`.`survey_answers` 
ADD COLUMN `answerOrder` INT NULL DEFAULT 1 AFTER `label`;


/** tracking table with triggers to log updates/deletes **/
CREATE TABLE `survey_answers_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `questionId` int(11) NOT NULL,
  `skipToPageId` int(11) NOT NULL DEFAULT '0',
  `skipToQuestionId` int(11) NOT NULL DEFAULT '0',
  `answer` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `activityCodeId` int(11) DEFAULT '0',
  `defAnswer` bit(1) NOT NULL DEFAULT b'0',
  `defAnsText` text COLLATE utf8_unicode_ci,
  `dateCreated` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `numericOnly` bit(1) NOT NULL DEFAULT b'0',
  `maxLength` int(11) DEFAULT '255',
  `label` text COLLATE utf8_unicode_ci,
  `answerOrder` int(11) DEFAULT '1',
  `dateArchive` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


ALTER TABLE `rapidregistry`.`survey_answers_log` 
RENAME TO  `rapidregistry`.`Log_survey_answers` ;

ALTER TABLE `rapidregistry`.`Log_survey_answers` 
ADD COLUMN `triggerType` VARCHAR(1) NULL AFTER `dateArchive`;


delimiter #

create trigger survey_answers_track_u after update on survey_answers
for each row
begin
  insert into Log_survey_answers (id, questionId, skipToPageId, skipToQuestionId, answer, activityCodeId,
  defAnswer, defAnsText, dateCreated, numericOnly, maxLength, label, answerOrder, triggerType)
  values (new.id, new.questionId, new.skipToPageId, new.skipToQuestionId, new.answer, new.activityCodeId,
  new.defAnswer, new.defAnsText, new.dateCreated, new.numericOnly, new.maxLength, new.label, new.answerOrder, 'U');
end#

delimiter ;



delimiter #

create trigger survey_answers_track_d before delete on survey_answers
for each row
begin
  insert into Log_survey_answers (id, questionId, skipToPageId, skipToQuestionId, answer, activityCodeId,
  defAnswer, defAnsText, dateCreated, numericOnly, maxLength, label, answerOrder, triggerType)
  values (OLD.id, old.questionId, old.skipToPageId, old.skipToQuestionId, OLD.answer, OLD.activityCodeId,
  OLD.defAnswer, OLD.defAnsText, OLD.dateCreated, OLD.numericOnly, OLD.maxLength, OLD.label, OLD.answerOrder, 'D');
end#

delimiter ;

