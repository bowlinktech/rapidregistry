
/** 4-20-15 @ 10:22 AM Chad **/

INSERT INTO `rapidregistry`.`lu_programModules` (`moduleName`, `displayName`) VALUES ('calendar', 'Calendar');
INSERT INTO `rapidregistry`.`lu_programModules` (`moduleName`, `displayName`) VALUES ('faq', 'FAQ');
INSERT INTO `rapidregistry`.`lu_programModules` (`moduleName`, `displayName`) VALUES ('forum', 'Forum');


CREATE TABLE `rapidregistry`.`calendarEventTypes` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `eventType` VARCHAR(55) NOT NULL,
  `eventTypeColor` VARCHAR(8) NOT NULL,
  `adminOnly` BIT(1) NOT NULL DEFAULT b'0',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `id_UNIQUE` (`id` ASC));

CREATE TABLE `rapidregistry`.`calendarNotificationPreferences` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `systemUserId` INT NOT NULL,
  `notificationEmail` VARCHAR(255) NOT NULL,
  `emailAlertMin` INT NOT NULL DEFAULT 0 COMMENT '0 = NO ALERTS\n1 = At time of event\n5 = 5 Min before\n10 = 10 Min before\n15 = 15 Min before\n30 = 30 min before\n60 = 1 hour before\n120 = 2 hour before\n1440 = 1 day before\n2880 = 2 days before\n',
  `newEventNotifications` BIT(1) NOT NULL DEFAULT b'1',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `id_UNIQUE` (`id` ASC));

CREATE TABLE `rapidregistry`.`calendarEvents` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `systemUserId` INT NOT NULL COMMENT 'The userID who created the event.',
  `eventDate` DATETIME NOT NULL,
  `eventStartTime` VARCHAR(10) NULL,
  `eventEndTime` VARCHAR(10) NULL,
  `eventTitle` VARCHAR(55) NOT NULL,
  `eventLocation` VARCHAR(255) NULL,
  `eventNotes` VARCHAR(255) NULL,
  `eventTypeId` INT NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE INDEX `id_UNIQUE` (`id` ASC));

CREATE TABLE `rapidregistry`.`calendarEventDocuments` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `calendarEventId` INT NOT NULL,
  `documentLocation` VARCHAR(255) NOT NULL,
  `documentTitle` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE INDEX `id_UNIQUE` (`id` ASC));

CREATE TABLE `rapidregistry`.`calendarEventUserNotifications` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `calendarEventId` INT NOT NULL,
  `systemUserId` INT NOT NULL,
  `emailAlertMin` INT NOT NULL DEFAULT '0' COMMENT '0 = NO ALERTS\n1 = At time of event\n5 = 5 Min before\n10 = 10 Min before\n15 = 15 Min before\n30 = 30 min before\n60 = 1 hour before\n120 = 2 hour before\n1440 = 1 day before\n2880 = 2 days before',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `id_UNIQUE` (`id` ASC));

ALTER TABLE `rapidregistry`.`calendarEvents` 
ADD COLUMN `programId` INT(11) NOT NULL AFTER `id`;

ALTER TABLE `rapidregistry`.`calendarEventTypes` 
ADD COLUMN `programId` VARCHAR(45) NOT NULL AFTER `id`;

CREATE TABLE `rapidregistry`.`forumMessages` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `programId` int(11) NOT NULL,
  `parentMessageId` int(11) NOT NULL DEFAULT '0' COMMENT '0 = Original Message',
  `topicType` int(11) NOT NULL DEFAULT '2' COMMENT '1 = Announcement\n2 = Regular Topic',
  `topicTitle` varchar(255) NOT NULL,
  `topicMessage` varchar(45) NOT NULL,
  `systemUserId` int(11) NOT NULL COMMENT 'The userId of the person who created the topic',
  `totalViews` int(11) NOT NULL DEFAULT '0',
  `totalReplies` int(11) NOT NULL DEFAULT '0',
  `dateCreated` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_UNIQUE` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `rapidregistry`.`forumDocuments` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `forumMessageId` varchar(45) NOT NULL,
  `documentLocation` varchar(255) NOT NULL,
  `documentTitle` varchar(255) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_UNIQUE` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `rapidregistry`.`faqQuestions` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `programId` INT(11) NOT NULL,
  `question` VARCHAR(255) NOT NULL,
  `answer` LONGTEXT NOT NULL,
  `displayPos` INT(11) NOT NULL DEFAULT '1',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `id_UNIQUE` (`id` ASC));

CREATE TABLE `rapidregistry`.`faqQuestionDocuments` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `faqId` INT(11) NOT NULL,
  `documentLocation` VARCHAR(255) NOT NULL,
  `documentTitle` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE INDEX `id_UNIQUE` (`id` ASC));
  
  
  /** grace 04.17.2015 05:58PM **/
ALTER TABLE `rapidregistry`.`put_formFields` 
ADD COLUMN `useField` BIT(1) NOT NULL DEFAULT 1 AFTER `dspPos`;

ALTER TABLE `rapidregistry`.`put_formFields` 
ADD COLUMN `multiValue` BIT(1) NULL DEFAULT 0 AFTER `useField`;

/** grace 04.21.2015 03:33PM **/
ALTER TABLE `rapidregistry`.`storage_engagements` 
ADD COLUMN `visitDate` DATETIME NULL AFTER `programorghierarchy_detailsId`,
ADD COLUMN `contraceptiveInitialId` INT NULL AFTER `contraceptiveMethodAfterId`,
ADD COLUMN `noContraceptiveReasonId` INT NULL AFTER `contraceptiveInitialId`;

ALTER TABLE `rapidregistry`.`storage_engagements` 
CHANGE COLUMN `referralDate` `referralDate` DATETIME NULL ;

ALTER TABLE `rapidregistry`.`storage_engagements` 
ADD COLUMN `BMI` DECIMAL(2) NULL AFTER `noContraceptiveReasonId`;

ALTER TABLE `rapidregistry`.`storage_engagements` 
CHANGE COLUMN `BMI` `BMI` FLOAT NULL DEFAULT NULL ,
ADD COLUMN `height` FLOAT NULL AFTER `BMI`,
ADD COLUMN `weight` FLOAT NULL AFTER `height`,
ADD COLUMN `bpDia` FLOAT NULL AFTER `weight`,
ADD COLUMN `bpSys` FLOAT NULL AFTER `bp_diastolic`;

delete from  `rapidregistry`.`storage_engagements`;

ALTER TABLE `rapidregistry`.`storage_engagements` 
CHANGE COLUMN `engagementId` `storage_patientsId` INT(11) NOT NULL ;

ALTER TABLE `rapidregistry`.`storage_engagements` 
DROP INDEX `engagementId_idx` ;

ALTER TABLE `rapidregistry`.`storage_engagements` 
ADD CONSTRAINT `fk_storage_patient`
  FOREIGN KEY (`storage_patientsId`)
  REFERENCES `rapidregistry`.`storage_patients` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  

/** Chad 4-23-2015 @ 10:15 AM **/

ALTER TABLE `rapidregistry`.`lu_programModules` 
ADD COLUMN `linkIcon` VARCHAR(45) NULL AFTER `displayName`;

UPDATE `rapidregistry`.`lu_programModules` SET `linkIcon`='fa-calendar' WHERE `id`='7';
UPDATE `rapidregistry`.`lu_programModules` SET `linkIcon`='fa-question' WHERE `id`='8';
INSERT INTO `rapidregistry`.`lu_programModules` (`moduleName`, `displayName`, `linkIcon`) VALUES ('document', 'Documents', 'fa-upload');
UPDATE `rapidregistry`.`lu_programModules` SET `linkIcon`='fa-archive' WHERE `id`='9';
UPDATE `rapidregistry`.`lu_programModules` SET `linkIcon`='fa-clock-o' WHERE `id`='6';
UPDATE `rapidregistry`.`lu_programModules` SET `linkIcon`='fa-download' WHERE `id`='4';
UPDATE `rapidregistry`.`lu_programModules` SET `linkIcon`='fa-user' WHERE `id`='1';
UPDATE `rapidregistry`.`lu_programModules` SET `linkIcon`='fa-bars' WHERE `id`='3';


/** grace 04-27-2015 1:25PM **/
ALTER TABLE `rapidregistry`.`storage_engagementMedicalServices` 
CHANGE COLUMN `engagementId` `storage_engagementId` INT(11) NOT NULL ;

delete from `rapidregistry`.`storage_engagementMedicalServices`;

ALTER TABLE `rapidregistry`.`storage_engagements` 
ADD COLUMN `engagementId` INT NULL AFTER `storage_patientsId`;

ALTER TABLE `rapidregistry`.`storage_engagementsMisc` 
CHANGE COLUMN `engagementId` `storage_engagementId` INT(11) NOT NULL ;

ALTER TABLE `rapidregistry`.`storage_engagementMedicalServices` 
ADD INDEX `mainStorageKey_idx` (`storage_engagementId` ASC);
ALTER TABLE `rapidregistry`.`storage_engagementMedicalServices` 
ADD CONSTRAINT `mainStorageKey`
  FOREIGN KEY (`storage_engagementId`)
  REFERENCES `rapidregistry`.`storage_engagements` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;


ALTER TABLE `rapidregistry`.`storage_engagementsMisc` 
ADD INDEX `FKStorageKey_idx` (`storage_engagementId` ASC);
ALTER TABLE `rapidregistry`.`storage_engagementsMisc` 
ADD CONSTRAINT `FKStorageKey`
  FOREIGN KEY (`storage_engagementId`)
  REFERENCES `rapidregistry`.`storage_engagements` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;


/** FP patients have multiple check boxes, need to be able to display back each one they checked on forms **/
CREATE TABLE `rapidregistry`.`storage_races` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `storage_engagementId` INT NOT NULL,
  `raceId` INT NOT NULL,
  PRIMARY KEY (`id`));


ALTER TABLE `rapidregistry`.`storage_races` 
ADD INDEX `FKStorageEngagementId_idx` (`storage_engagementId` ASC);
ALTER TABLE `rapidregistry`.`storage_races` 
ADD CONSTRAINT `FKStorageEngagementId`
  FOREIGN KEY (`storage_engagementId`)
  REFERENCES `rapidregistry`.`storage_engagements` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
  CREATE TABLE `rapidregistry`.`storage_localCodes` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `storage_engagementId` INT NOT NULL,
  `localCode` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`id`));
  
  
  ALTER TABLE `rapidregistry`.`storage_localCodes` 
ADD INDEX `storage_engagementId_idx` (`storage_engagementId` ASC);
ALTER TABLE `rapidregistry`.`storage_localCodes` 
ADD CONSTRAINT `storage_engagementId`
  FOREIGN KEY (`storage_engagementId`)
  REFERENCES `rapidregistry`.`storage_engagements` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  


/** 4-30-15 @ 03:29 PM Jim **/

ALTER TABLE `rapidregistry`.`calendarEventTypes` 
CHANGE COLUMN `programId` `programId` INT(11) NOT NULL ;

/** 5-01-15 @ 10:43 AM Jim **/

ALTER TABLE `rapidregistry`.`calendarEvents` 
CHANGE COLUMN `eventDate` `eventStartDate` DATETIME NOT NULL ,
ADD COLUMN `eventEndDate` DATETIME NOT NULL AFTER `eventStartDate`;


/** 05.01.15 11:13AM Grace **/
INSERT INTO `rapidregistry`.`lu_processstatus` (`id`, `category`, `displayCode`, `displayText`, `description`, `status`, `isCustom`, `endUserDisplayCode`, `endUserDisplayText`, `endUserDescription`) VALUES ('43', 'batch', 'RBL', 'RR Submission Being Loaded', 'RR file being loaded for processing', 1, 0, 'RBL', 'RR Submission Being Loaded', 'RR file being loaded for processing');

ALTER TABLE `rapidregistry`.`programUploadRecords` 
ADD COLUMN `statusId` INT NULL AFTER `programUploadId`;

CREATE TABLE `rapidregistry`.`programUploadRecords_storageInfo` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `storage_engagementsId` INT NOT NULL,
  `programUploadRecordsId` INT NOT NULL,
  PRIMARY KEY (`id`));
  
ALTER TABLE `rapidregistry`.`storage_engagements` 
ADD COLUMN `programId` INT NULL AFTER `engagementId`;

/** grace 05.04.2015 12:02PM **/
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='9';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='10';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='11';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='12';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='13';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='14';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='15';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='16';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='17';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='18';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='19';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='20';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='31';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='33';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='37';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='25';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='30';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='8';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='5';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='6';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='3';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='22';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='23';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='24';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='28';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='29';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='32';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='35';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='36';
DELETE FROM `rapidregistry`.`lu_processstatus` WHERE `id`='38';



CREATE TABLE `rapidregistry`.`log_programUpload` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `programUploadId` INT NOT NULL,
  `statusId` INT NULL,
  `statusTime` DATETIME NULL DEFAULT current_timestamp,
  PRIMARY KEY (`id`));

ALTER TABLE `rapidregistry`.`log_programUpload` 
ADD INDEX `fk_pu_idx` (`programUploadId` ASC);
ALTER TABLE `rapidregistry`.`log_programUpload` 
ADD CONSTRAINT `fk_pu`
  FOREIGN KEY (`programUploadId`)
  REFERENCES `rapidregistry`.`programuploads` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
ALTER TABLE `rapidregistry`.`log_programUpload` 
ADD COLUMN `activity` VARCHAR(1) NULL COMMENT 'u for update, i for insert' AFTER `statusTime`;
  
ALTER TABLE `rapidregistry`.`log_programUpload` 
CHANGE COLUMN `statusId` `statusId` INT(11) NOT NULL ,
CHANGE COLUMN `statusTime` `statusTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ,
CHANGE COLUMN `activity` `activity` VARCHAR(1) NOT NULL COMMENT 'u for update, i for insert' ;

  use rapidregistry;
  drop trigger if exists programUploadLog_ins;
   drop trigger if exists programUploadLog;
  
  
  
  DELIMITER ;;
CREATE trigger programUploadLog_ins after insert on programUploads
for each row
begin
  insert into log_programUpload (statusId, programUploadId, activity) 
values (new.statusId, new.id, 'i');
end ;;
DELIMITER ;
  
  
  DELIMITER ;;
CREATE trigger programUploadLog after update on programUploads
for each row
begin
  insert into log_programUpload (statusId, programUploadId,activity ) 
values (new.statusId, new.id, 'u');
end ;;
DELIMITER ;

/** 05.05.15 @ 11:21 AM Chad **/
DROP TABLE `rapidregistry`.`user_permissions`;

ALTER TABLE `rapidregistry`.`user_programModules` 
ADD COLUMN `allowCreate` BIT(1) NOT NULL DEFAULT b'0' AFTER `moduleId`,
ADD COLUMN `allowEdit` BIT(1) NOT NULL DEFAULT b'1=0' AFTER `create`,
ADD COLUMN `allowDelete` BIT(1) NOT NULL DEFAULT b'0' AFTER `edit`,
ADD COLUMN `allowLevel1` BIT(1) NOT NULL DEFAULT b'0' AFTER `delete`,
ADD COLUMN `allowLevel2` BIT(1) NOT NULL DEFAULT b'0' AFTER `level1`,
ADD COLUMN `allowLevel3` BIT(1) NOT NULL DEFAULT b'0' AFTER `level2`,
ADD COLUMN `allowReconcile` BIT(1) NOT NULL DEFAULT b'0' AFTER `level3`,
ADD COLUMN `allowImport` BIT(1) NOT NULL DEFAULT b'0' AFTER `reconcile`,
ADD COLUMN `allowExport` BIT(1) NOT NULL DEFAULT b'0' AFTER `import`;


/** grace 05052015 1:05PM **/
ALTER TABLE `rapidregistry`.`programUploadRecords` 
DROP COLUMN `statusId`,
CHANGE COLUMN `programUploadId` `programUploadRecordId` INT(11) NOT NULL , RENAME TO  `rapidregistry`.`programUploadRecordDetails` ;

ALTER TABLE `rapidregistry`.`programUploadRecordDetails` 
ADD COLUMN `processTableId` INT NULL AFTER `programUploadRecordId`,
ADD COLUMN `dateCreated` DATETIME NULL DEFAULT current_timestamp AFTER `processTableId`;

CREATE TABLE `rapidregistry`.`programUploadRecords` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `programUploadId` INT NOT NULL,
  `statusId` INT NOT NULL,
  `loadTableId` VARCHAR(45) NULL,
  `dateCreated` DATETIME NOT NULL DEFAULT current_timestamp,
  PRIMARY KEY (`id`));

  ALTER TABLE `rapidregistry`.`programUploadRecords` 
ADD INDEX `FK_PUR_PU_idx` (`programUploadId` ASC);
ALTER TABLE `rapidregistry`.`programUploadRecords` 
ADD CONSTRAINT `FK_PUR_PU`
  FOREIGN KEY (`programUploadId`)
  REFERENCES `rapidregistry`.`programuploads` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
  DELETE FROM `rapidregistry`.`lu_errorcodes` WHERE `id`='3';
DELETE FROM `rapidregistry`.`lu_errorcodes` WHERE `id`='4';
  
/** chad 05062015 @ 12:32 PM **/
INSERT INTO `rapidregistry`.`lu_programModules` (`moduleName`, `displayName`,  `linkIcon`) VALUES ('surveys', 'Surveys', 'fa-server');


/** chad 05062015 @ 2:23 PM **/
ALTER TABLE `rapidregistry`.`programOrgHierarchy_details` 
CHANGE COLUMN `zipcode` `zipCode` VARCHAR(255) CHARACTER SET 'utf8' COLLATE 'utf8_unicode_ci' NULL DEFAULT NULL ;

/** grace 05.06.15 12:17PM **/
ALTER TABLE `rapidregistry`.`programuploadtypes` 
DROP FOREIGN KEY `fk_fileTypeId`;
ALTER TABLE `rapidregistry`.`programuploadtypes` 
CHANGE COLUMN `fileTypeId` `inFileTypeId` INT(11) NOT NULL ,
ADD COLUMN `outFileTypeId` INT NULL AFTER `inFileTypeId`,
ADD INDEX `fk_outFileTypeId_idx` (`outFileTypeId` ASC);
ALTER TABLE `rapidregistry`.`programuploadtypes` 
ADD CONSTRAINT `fk_fileTypeId`
  FOREIGN KEY (`inFileTypeId`)
  REFERENCES `rapidregistry`.`lu_filetypes` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION,
ADD CONSTRAINT `fk_outFileTypeId`
  FOREIGN KEY (`outFileTypeId`)
  REFERENCES `rapidregistry`.`lu_filetypes` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
INSERT INTO `rapidregistry`.`lu_processstatus` (`id`, `category`, `displayCode`, `displayText`, `description`, `status`, `isCustom`, `endUserDisplayCode`, `endUserDisplayText`, `endUserDescription`) VALUES ('44', 'batch', 'OFE', 'HEL Output File Error', 'HEL\'s output file extension  for RR not as expected', 1, 0, 'OFE', 'HEL Output File Error', 'HEL\'s output file extension  for RR not as expected');
  
ALTER TABLE `rapidregistry`.`programuploadtypes` 
ADD COLUMN `containsHeaderRow` BIT NOT NULL DEFAULT 0 AFTER `dateCreated`;


/** grace 05.07.2015 11:01AM **/
INSERT INTO `rapidregistry`.`lu_processstatus` (`id`, `category`, `displayCode`, `displayText`, `description`, `endUserDisplayCode`, `endUserDisplayText`, `endUserDescription`) VALUES ('9', 'record', 'LOA', 'Record Loaded', 'Normal condition: The record has been successfully loaded for processing.', 'LOA', 'Record Loaded', 'Normal condition: The record has been successfully loaded for processing.');

ALTER TABLE `rapidregistry`.`programUploadRecordDetails` 
CHANGE COLUMN `processTableId` `loadTableId` VARCHAR(45) NULL DEFAULT NULL ,
CHANGE COLUMN `dateCreated` `dateCreated` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ;
 
 
 /** grace 05.08.2015 1:37AM **/
 ALTER TABLE `rapidregistry`.`programUpload_errors` 
ADD COLUMN `dspPos` INT NULL AFTER `fieldNo`;

 /** grace 05.08.2015 12:50PM **/
ALTER TABLE `rapidregistry`.`programUploadRecordDetails` 
ADD COLUMN `programUploadId` INT NOT NULL AFTER `id`;

/** grace 05.11.2015 12:15AM **/

use rapidregistry;

drop procedure if exists  `stripPhoneChars`;

DELIMITER $$

CREATE DEFINER=`root`@`localhost` PROCEDURE `stripPhoneChars`(in vtType int, in dspPos int,
in programUploadId int, in programUploadRecordId int)
BEGIN
	DECLARE varToReplace varchar(100) DEFAULT '.';
	DECLARE part1 varchar(255) DEFAULT '.';
	DECLARE part2 varchar(25) DEFAULT '.';
	
	if (programUploadRecordId = 0) then
	BEGIN
		set part1 = concat("update programUploadRecordDetails JOIN (SELECT id from programUploadRecord WHERE programUploadId = ", programUploadId, 
        " and statusId not in (11,12,13,16)) as ti ON programUploadRecordDetails.programUploadRecordId = ti.id SET programUploadRecordDetails.F"
	  , fieldNo, " = replace(F", fieldNo, ", '");
	END;
	END if;

	if (programUploadRecordId != 0) then
	BEGIN
	  set part1 = concat("update programUploadRecordDetails JOIN (SELECT id from programUploadRecord WHERE id = ",
	  programUploadRecordId, ") as ti ON programUploadRecordDetails.programUploadRecordId = ti.id SET programUploadRecordDetails.F"
	  , fieldNo, " = replace(F", fieldNo, ", '");
	END;
	END if;

	
	set part2 = "', '');";
	set @stmt = concat(part1, varToReplace, part2);
  	PREPARE stmt from @stmt;
	EXECUTE stmt;

	set varToReplace = '-';
	set @stmt = concat(part1, varToReplace, part2);
	PREPARE stmt from @stmt;
	EXECUTE stmt;

	set varToReplace = ')';
	set @stmt = concat(part1, varToReplace, part2);
	PREPARE stmt from @stmt;
	EXECUTE stmt;

	set varToReplace = '(';
	set @stmt = concat(part1, varToReplace, part2);
	PREPARE stmt from @stmt;
	EXECUTE stmt;

	set varToReplace = ' ';
	set @stmt = concat(part1, varToReplace, part2);
	PREPARE stmt from @stmt;
	EXECUTE stmt;

 END$$
 
DELIMITER ;

DELETE FROM `rapidregistry`.`lu_errorcodes` WHERE `id`='6';
UPDATE `rapidregistry`.`lu_errorcodes` SET `displayText`='Failed Email Validation', `description`='Failed Email Validation' WHERE `id`='2';
INSERT INTO `rapidregistry`.`lu_errorcodes` (`id`, `displayText`, `description`) VALUES ('28', 'Failed Phone Validation', 'Failed Phone Validation');
INSERT INTO `rapidregistry`.`lu_errorcodes` (`id`, `displayText`, `description`) VALUES ('29', 'Failed Date Validation', 'Failed Date Validation');
INSERT INTO `rapidregistry`.`lu_errorcodes` (`id`, `displayText`, `description`) VALUES ('30', 'Failed Numeric Validation', 'Failed Numeric Validation');
INSERT INTO `rapidregistry`.`lu_errorcodes` (`id`, `displayText`, `description`) VALUES ('31', 'Failed URL Validation', 'Failed URL Validation');

ALTER TABLE `rapidregistry`.`programUpload_errors` 
CHANGE COLUMN `fieldNo` `fieldId` INT(11) NULL DEFAULT NULL ;


use rapidregistry;

drop procedure if exists insertValidationErrors;
DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `insertValidationErrors`(in vtType int, in dspPos int, in fieldId int,
in programUploadId int, in programUploadRecordId int)

BEGIN

DECLARE regEx varchar(100) DEFAULT '';
DECLARE errorId int DEFAULT 0;


CASE vtType
	WHEN 2 THEN 
		BEGIN set regEx = '^[A-Z0-9._%-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$';
        set errorId = 2;
        END;
    WHEN 3 THEN 
		BEGIN 
			CALL `rapidregistry`.`stripPhoneChars`(vtType, dspPos, programUploadId,  programUploadRecordId);
			set regEx ='^[0-9]{7,11}$';
            set errorId = 28;
		END;
	WHEN 5 THEN BEGIN
		set regEx = '^-?[0-9]+[.]?[0-9]*$|^-?[.][0-9]+$';
        set errorId = 30;
        END;
    ELSE
        BEGIN
        END;
	END 
	CASE;

IF (programUploadRecordId = 0) THEN
set @stmt = concat(
'insert into programUpload_Errors (programUploadId, programUploadRecordId, dspPos, fieldId, errorid, errorData) 
SELECT ', programUploadId, ', programUploadRecordId, ',dspPos,',' , fieldId, ', ' , errorId, ', F',  dspPos, 
' FROM programUploadRecordDetails WHERE trim(F' ,dspPos, ') not REGEXP  "', regEx, '" and F',dspPos, ' is not null 
and length(F', dspPos, ') != 0
and length(trim(F', dspPos, ')) != 0
and length(REPLACE(REPLACE(F', dspPos,' , "\n", ""), "\r", "") != 0)  and programUploadRecordId 
in (select id from programUploadRecords where programUploadId = ', programUploadId,' and statusId not in (11,12,13,16));'
);

BEGIN -- true
		PREPARE stmt from @stmt;
		EXECUTE stmt;
END; 
END IF;

IF (programUploadRecordId != 0) THEN

set @stmt= concat(
'insert into programUpload_Errors (programUploadId, programUploadRecordId, dspPos,  fieldId, errorid, errorData) 
SELECT ', programUploadId, ', programUploadRecordId, ',dspPos, ',', fieldId,',', errorId, ', F',dspPos, 
' FROM programUploadRecordDetails WHERE trim(F' ,dspPos, ') not REGEXP  "', regEx, '" and F',dspPos, ' is not null 
and length(F', dspPos, ') != 0
and length(trim(F', dspPos, ')) != 0
and length(REPLACE(REPLACE(F', dspPos,', "\n", ""), "\r", "") != 0) and programUploadRecordId = ', 
programUploadRecordId);

BEGIN -- true
		PREPARE stmt from @stmt;
		EXECUTE stmt;


END; 
END IF;


END$$
DELIMITER ;


/** grace 05.11.2015 03:16PM **/
use rapidregistry;

drop procedure if exists  `stripPhoneChars`;

CREATE DEFINER=`root`@`localhost` PROCEDURE `stripPhoneChars`(in vtType int, in dspPos int,
in programUploadId int, in programUploadRecordId int)
BEGIN
	DECLARE varToReplace varchar(100) DEFAULT '.';
	DECLARE part1 varchar(255) DEFAULT '.';
	DECLARE part2 varchar(25) DEFAULT '.';
	
	if (programUploadRecordId = 0) then
	BEGIN
		set part1 = concat("update programUploadRecordDetails JOIN (SELECT id from programUploadRecords WHERE programUploadId = ", programUploadId, 
        " and statusId not in (11,12,13,16)) as ti ON programUploadRecordDetails.programUploadRecordId = ti.id SET programUploadRecordDetails.F"
	  , dspPos, " = replace(F", dspPos, ", '");
	END;
	END if;

	if (programUploadRecordId != 0) then
	BEGIN
	  set part1 = concat("update programUploadRecordDetails JOIN (SELECT id from programUploadRecords WHERE id = ",
	  programUploadRecordId, ") as ti ON programUploadRecordDetails.programUploadRecordId = ti.id SET programUploadRecordDetails.F"
	  , dspPos, " = replace(F", dspPos, ", '");
	END;
	END if;

	
	set part2 = "', '');";
	set @stmt = concat(part1, varToReplace, part2);
  	PREPARE stmt from @stmt;
	EXECUTE stmt;

	set varToReplace = '-';
	set @stmt = concat(part1, varToReplace, part2);
	PREPARE stmt from @stmt;
	EXECUTE stmt;

	set varToReplace = ')';
	set @stmt = concat(part1, varToReplace, part2);
	PREPARE stmt from @stmt;
	EXECUTE stmt;

	set varToReplace = '(';
	set @stmt = concat(part1, varToReplace, part2);
	PREPARE stmt from @stmt;
	EXECUTE stmt;

	set varToReplace = ' ';
	set @stmt = concat(part1, varToReplace, part2);
	PREPARE stmt from @stmt;
	EXECUTE stmt;

 END

/** grace 05.13.2015 04:52 PM **/
UPDATE `rapidregistry`.`lu_errorcodes` SET `displayText`='Invalid Organization Hierarchy Definition', `description`='Zero or more than one field defined as organization hierarchy Id', `dateCreated`= current_timestamp, `dateModified`=current_timestamp WHERE `id`='8';

/** grace 05.14.2015 12:09 AM **/
ALTER TABLE `rapidregistry`.`put_formFields` 
CHANGE COLUMN `requiredFIeld` `requiredField` BIT(1) NOT NULL DEFAULT b'0' ;

 